# 11.7 长按一下就下载

>##### 学习Tips：我们使用封装完成的歌曲下载工具类，完成歌曲下载的主体部分，但是为了区别点击歌曲列表中的某一首歌曲时就进行播放，我们这里需要使用长按事件处理歌曲下载。

## 1. 学习视频

<iframe frameborder="0" width="640" height="498" src="https://v.qq.com/iframe/player.html?vid=z0180bhmznp&tiny=0&auto=0" allowfullscreen></iframe>

## 2. 添加长按下载事件

创建上下文菜单

```
  @Override
  public void onCreateContextMenu(ContextMenu menu, View v,
          ContextMenuInfo menuInfo) {
      menu.setHeaderIcon(android.R.drawable.ic_dialog_info);
      menu.setHeaderTitle("操作");
      //添加上下文菜单
      menu.add(1, 0, 1, "下载");
      super.onCreateContextMenu(menu, v, menuInfo);
  }
```

DownloadAsyncTask异步下载任务类

```
  class DownloadAsyncTask extends AsyncTask<String, Void, String>{
      @Override
      protected String doInBackground(String... params) {
        //构建服务器连接地址
        String uri = Config.SERVICE_IP+"mp3/"+params[0];
        //String path = Environment.getExternalStorageDirectory().toString()+ "/mp3";
        System.out.println("uri"+uri);
        try {
          HttpEntity entity = HttpUtils.getEntity(uri, null, HttpUtils.METHOD_GET);
          InputStream is = HttpUtils.getInputStream(entity);

          File sdcardDir = Environment.getExternalStorageDirectory();
          File file = new File(sdcardDir+"/mp3/"+params[0]);
          file.createNewFile();
          //获取指向文件的输出流对象
          FileOutputStream os = new FileOutputStream(file);
          byte[] buffer = new byte[1024*4]; // 每次读取字节的缓冲数组
          BufferedInputStream in = new BufferedInputStream(is);
          BufferedOutputStream out = new BufferedOutputStream(os);
          int len = -1;
          while((len=is.read(buffer))!=-1){
              // 将读取的1k内容输出到输出流
              out.write(buffer, 0, len);
              // 清理缓存
              out.flush();
          }
          out.close();
          os.close();
          in.close();
          is.close();
          return "下载完成";
        } catch (Exception e) {
          e.printStackTrace();
          return "下载失败";
        }			
      }		
  }
```